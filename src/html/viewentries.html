<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>View Entries</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.6/css/all.css">
    <link rel="stylesheet" href="css/bootstrap.min.css" id="bootstrap-css">
    <link href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
    <link href="css/sidebar.css" rel="stylesheet">
    <link href="css/home.css" rel="stylesheet">
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script
      src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
      integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
      crossorigin="anonymous"></script>
    <script src="js/common.js"></script>

</head>

<body>

    <div id="wrapper">

        <div id="sidebar"></div>

        <div id="page-content-wrapper">
            <div class="container-fluid">
                <h1>View entries</h1><br>
                <table class="table table-hover" id="table-entries">
                    <thead class="thead-light">
                        <th style="width: 5%">#</th>
                        <th style="width: 35%">Title</th>
                        <th style="width: 25%">Author</th>
                        <th style="width: 25%">Publish Date</th>
                        <th style="width: 10%">Actions</th>
                    </thead>
                    <tbody>
                    </tbody>
                    <!--
                    <tr>
                        <td>1</td>
                        <td>Sample entry</td>
                        <td>John Doe</td>
                        <td>2018-02-30</td>
                        <td>
                            <button class="btn btn-circle" id="btnView" value="2"><i class="far fa-file-alt"></i></button>
                            <button class="btn btn-circle" id="btnDelete" value="2"><i class="far fa-trash-alt"></i></button>
                        </td>
                    </tr>
                -->
                </table>
            </div>
        </div>

    </div>

    <div id="entry-details-dialog">
        <p id="entry-text"></p>
    </div>

    <div id="entry-details-addnl-dialog">
        <label id="label-viewable-public-addnl">    
            <input type="checkbox" id="viewable-public-addnl" class="p-3">
              Viewable by public
        </label><br><hr>
        <div id="div-entry-text-addnl"><p id="entry-text-addnl"></p></div>
    </div>

    <script>

        var diaryEntriesId = {};

        $(document).ready(function() {

            $('#sidebar').load("sidebar.html");

            var group = getUrlParameter("group");
            populateTable(group);
            setButtonOnclick(group);

            $('#entry-details-dialog').dialog({
                width: 800,
                autoOpen: false,
                modal: true,
                title: 'Diary Entry',
                buttons: {
                    Close: function() {
                        $(this).dialog('close');
                    }
                }
            });

            $('#entry-details-addnl-dialog').dialog({
                width: 800,
                autoOpen: false,
                modal: true,
                title: 'Diary Entry',
                buttons: {
                    Save: function() {
                        var formData = {
                            "token": getCookie("uuid"),
                            "id": $('#entry-text-addnl').val(),
                            "public": $('#viewable-public-addnl').prop('checked')
                        };
                        var jsonData = JSON.stringify(formData);

                        $.ajax({
                            type: "POST",
                            url: "http://localhost:8080/diary/permission",
                            dataType: "json",
                            contentType: "application/json",
                            data: jsonData,
                            success: function(response) {
                                if (response.status) {
                                    alert("Permissions updated");
                                } else {
                                    alert(response.error);
                                }
                            },
                            error: function() {
                                alert('Error. Please try again.');
                            }
                        });
                    },
                    Close: function() {
                        $(this).dialog('close');
                    }
                }
            });

        });

        function populateTable(group) {
            /*
            var response = {
              "status": true,
              "result": [
                {
                  "id": 2,
                  "title": "A New Lesson!",
                  "author": "audrey123talks",
                  "publish_date": "2013-02-29T13:37:00+00:00",
                  "public": true,
                  "text": "Check out my latest video!"
                },
                {
                  "id": 3,
                  "title": "No One Can See This Post",
                  "author": "audrey123talks",
                  "publish_date": "2013-02-29T13:38:00+00:00",
                  "public": false,
                  "text": "currently we SMB mount the host filesystem in the Linux VM so we are currently bound by whatever functionality that offers (and it doesn’t support change notifications, aka inotify, on the Linux side). On the Mac we are using a custom filesystem based on FUSE which allows us to reflect change events from the host into the Linux VM (where they pop up as inotify events). This isn’t perfect because there are some differences in the filesystem semantics between MacOS and Linux, but they are reasonably close. We are looking into implementing something similar on Windows, but the filesystem semantics on Windows are significantly more different."
                }
              ]
            };
            parseToHtml(response.result, group);
            */
            if (group === "self") {
                var formData = { token: getCookie("uuid") };                            
                var jsonData = JSON.stringify(formData);

                $.ajax({
                    type: "POST",
                    url: "http://localhost:8080/diary",
                    dataType: "json",
                    contentType: "application/json",
                    data: jsonData,
                    success: function(response) {
                        if (response.status) {
                            parseToHtml(response.result, group);
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function() {
                        alert('Error. Please try again.');
                    }
                });
            } else if (group === "public") {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:8080/diary",
                    success: function(response) {
                        if (response.status) {
                            parseToHtml(response.result, group);
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function() {
                        alert('Error. Please try again.');
                    }
                });   
            }
        }

        function setButtonOnclick(group) {
            $("button[id='btnView']").click(function() {
                var entryDetails = diaryEntriesId[$(this).val()];
                console.log("id = " + $(this).val() + ", " + entryDetails);
                if (group === "self") {
                    if (entryDetails.public) {
                        $('#viewable-public-addnl').attr('checked', true);
                    }
                    $('#entry-text-addnl').text(entryDetails.text);
                    $('#entry-text-addnl').val($(this).val());
                    $('#entry-details-addnl-dialog').dialog('open');
                } else if (group === "public") {
                    $('#entry-text').text(entryDetails.text);
                    $('#entry-details-dialog').dialog('open');
                }
            });
            
            $("button[id='btnDelete']").click(function() {
                $('<div></div>').appendTo('body')
                    .html('<div><p>Are you sure you want to delete this entry?</p></div>')
                    .dialog({
                        modal: true, title: 'Confirm Entry Deletion', zIndex: 10000, autoOpen: true,
                        width: 'auto', resizable: false,
                        buttons: {
                            Yes: function () {
                                var data = { 
                                    token: getCookie("uuid"),
                                    id: $(this).val()
                                };
                                var jsonData = JSON.stringify(data);

                                $.ajax({
                                    type: 'POST',
                                    url: 'http://localhost:8080/diary/delete',
                                    dataType: "json",
                                    contentType: "application/json",
                                    data: jsonData,
                                    success: function(response) {
                                        if (response.status) {
                                            alert("Diary entry deleted.");
                                        } else {
                                            alert(response.error);
                                        }
                                    },
                                    error: function() {
                                        alert('Error. Please Try Again.');
                                    }
                                });

                                $(this).dialog('close');
                            },
                            No: function () {
                                $(this).dialog('close');
                            }
                        },
                        close: function (event, ui) {
                            $(this).remove();
                        }
                    })
            });
        }

        function parseToHtml(entries, group) {
            var html = "";
            var count = 1;
            console.log(entries);

            for (var i in entries) {
                diaryEntriesId[entries[i].id] = entries[i];

                html += "<tr>";
                html += "<td>" + count + "</td>";
                html += "<td>" + entries[i].title + "</td>";
                html += "<td>" + entries[i].author + "</td>";
                html += "<td>" + entries[i].publish_date + "</td>";
                html += "<td><button class='btn btn-circle' id='btnView' title='View Text' value='" + entries[i].id + "'><i class='far fa-file-alt'></i></button>";
                if (group === "self") {
                    html += "<button class='btn btn-circle' id='btnDelete' title='Delete' value='" + entries[i].id + "'><i class='far fa-trash-alt'></i></button></td>";
                } else  {
                    html += "</td>";
                }
                html += "</tr>";
                count++;
            }

            $('#table-entries > tbody').html(html);
        }

    </script>

</body>

</html>